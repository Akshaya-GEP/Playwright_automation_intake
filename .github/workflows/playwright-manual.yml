name: Playwright (manual)

on:
  workflow_dispatch:
    inputs:
      run:
        description: What to run
        required: true
        type: choice
        options:
          - suite
          - agent-1
          - agent-1.2
          - agent-2
          - agent-2.1
          - agent-3
          - agent-3.1
          - agent-4
          - agent-4.1
          - agent-5
          - agent-5.1

jobs:
  test:
    name: Run Playwright
    runs-on: ubuntu-latest

    # Use Playwright's official image so all browser deps are already available.
    container: mcr.microsoft.com/playwright:v1.50.1-jammy

    env:
      # Required by your test harness:
      BASE_URL: ${{ secrets.BASE_URL }}
      QUBE_MESH_URL: ${{ secrets.QUBE_MESH_URL }}
      USER_ID: ${{ secrets.USER_ID }}
      PASSWORD: ${{ secrets.PASSWORD }}

      # Avoid downloading browsers during npm install inside the container.
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
      CI: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Validate required secrets
        run: |
          missing=0
          for k in BASE_URL QUBE_MESH_URL USER_ID PASSWORD; do
            if [ -z "${!k}" ]; then
              echo "::error::Missing required secret/env: $k"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Run tests
        run: |
          target=""
          case "${{ inputs.run }}" in
            suite) target="automation/tests" ;;
            agent-1) target="automation/tests/agent1.spec.ts" ;;
            agent-1.2) target="automation/tests/agent1.2.spec.ts" ;;
            agent-2) target="automation/tests/agent2.spec.ts" ;;
            agent-2.1) target="automation/tests/agent2.1.spec.ts" ;;
            agent-3) target="automation/tests/agent3.spec.ts" ;;
            agent-3.1) target="automation/tests/agent3_1.spec.ts" ;;
            agent-4) target="automation/tests/agent4.spec.ts" ;;
            agent-4.1) target="automation/tests/agent4.1.spec.ts" ;;
            agent-5) target="automation/tests/agent5.spec.ts" ;;
            agent-5.1) target="automation/tests/agent5_1.spec.ts" ;;
            *) echo "::error::Unknown selection: ${{ inputs.run }}"; exit 2 ;;
          esac

          echo "Running: $target"
          npx playwright test --project=chromium "$target"

      - name: Upload Playwright HTML report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          if-no-files-found: warn

      - name: Upload Playwright artifacts (screenshots/videos/traces)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          if-no-files-found: warn


